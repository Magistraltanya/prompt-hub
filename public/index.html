<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Magistral Prompt Hub</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="site-header">
    <div class="wrap head-flex">
      <a href="#" class="logo-area">
        <div>
          <h1>Magistral</h1>
          <p class="tagline">Prompt Hub</p>
        </div>
      </a>
    </div>
  </header>

  <div class="toolbar">
    <div class="wrap toolbar-inner">
      <div class="left">
        <input id="searchBox" placeholder="Search text...">
        <select id="categorySelect"><option value="">All categories</option></select>
        <select id="subtypeSelect" disabled><option value="">All subtypes</option></select>
        <select id="sortSelect">
            <option value="newest">Sort by: Newest</option>
            <option value="oldest">Sort by: Oldest</option>
            <option value="copied">Sort by: Most Copied</option>
            <option value="alphabetical">Sort by: Alphabetical</option>
        </select>
        <button id="refreshBtn" class="btn btn-icon" aria-label="Refresh prompts">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 4l1.5 1.5A9 9 0 0120.5 15M20 20l-1.5-1.5A9 9 0 013.5 9"></path></svg>
        </button>
      </div>
      <div class="right">
        <button id="exportBtn" class="btn">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
            Export
        </button>
        <button id="analyticsBtn" class="btn">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
            Analytics
        </button>
        <button id="addBtn" class="btn btn-accent">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
          Add Prompt
        </button>
      </div>
    </div>
  </div>

  <main class="wrap">
    <div id="loader" class="loader">
      <div class="loader-spinner"></div>
      Loading Prompts...
    </div>
    <section id="promptList" class="grid"></section>
    <nav id="pager" class="pager"></nav>
  </main>

  <dialog id="promptModal">
    <form id="promptForm" method="dialog">
      <h3 id="modalTitle">Add Prompt</h3>
      <div class="two">
        <label>Category (e.g., Research, Marketing)<input id="serviceInput" required></label>
        <label>Subtype (e.g., CIM, Decks)<input id="subtypeInput"></label>
      </div>
      <label>Short description (1‚Äì2 lines)<input id="descInput" maxlength="200" placeholder="What this prompt produces..."></label>
      <div class="two">
        <label>AI tool (name or URL)<input id="toolInput" placeholder="ChatGPT, DALL¬∑E, or https://..."></label>
        <label>Contributor<input id="contribInput" value="Tanya" required></label>
      </div>
      <label>Prompt (full text)<textarea id="textInput" required></textarea></label>
      <label>Usage Guidelines (Optional)
        <textarea id="guidelinesInput" placeholder="e.g., 'Use with GPT-4 for best results. Ensure all 3 placeholders are replaced.'"></textarea>
      </label>
      <menu>
        <button type="button" id="cancelForm" class="btn">Cancel</button>
        <button id="saveBtn" value="default" class="btn btn-accent">Save</button>
      </menu>
    </form>
  </dialog>

  <dialog id="viewModal">
    <div class="view-head">
      <div class="view-meta">
        <span id="vhCat" class="badge"></span>
        <span id="vhSub" class="chip"></span>
        <span id="vhTool" class="tool"></span>
      </div>
      <div class="view-actions">
        <button id="vCopy" class="btn">üìã Copy</button>
        <button id="vEdit" class="btn">‚úèÔ∏è Edit</button>
        <button id="vDelete" class="btn btn-danger">üóëÔ∏è Delete</button>
        <button id="vClose" class="btn">‚úñ</button>
      </div>
    </div>
    <div class="view-body">
        <div class="view-main-content">
            <div class="view-section">
                <h4>Description</h4>
                <p id="vhDesc"></p>
            </div>
            <div id="guidelinesSection" class="view-section" style="display: none;">
                <h4>Usage Guidelines</h4>
                <div class="guidelines" id="vhGuidelines"></div>
            </div>
            <div class="view-section">
                <h4>Prompt Text</h4>
                <pre class="prompt-text" id="vhText"></pre>
            </div>
        </div>
        <div class="view-sidebar">
            <div class="view-section">
                <h4>Details</h4>
                <ul class="details-list">
                    <li id="detailContrib"><strong>Contributor:</strong> <span></span></li>
                    <li id="detailCreated"><strong>Created:</strong> <span></span></li>
                    <li id="detailEditor" style="display: none;"><strong>Last Editor:</strong> <span></span></li>
                    <li id="detailEdited" style="display: none;"><strong>Last Edited:</strong> <span></span></li>
                    <li id="detailCopied"><strong>Copied:</strong> <span></span></li>
                </ul>
            </div>
        </div>
    </div>
  </dialog>
  
  <dialog id="analyticsModal">
      <div class="view-head">
        <h3>Usage Analytics</h3>
        <button id="analyticsClose" class="btn">‚úñ</button>
      </div>
      <div class="analytics-content">
        <div class="analytics-grid">
            <div class="analytics-card" id="topCopiedCard">
                <h4>Most Copied Prompts</h4>
                <ul class="analytics-list" id="topCopiedList"></ul>
            </div>
            <div class="analytics-card" id="coldPromptsCard">
                <h4>Unused Prompts</h4>
                <ul class="analytics-list" id="coldPromptsList"></ul>
            </div>
            <div class="analytics-card" id="categoryCountCard">
                <h4>Usage by Category</h4>
                <ul class="analytics-list" id="categoryCountList"></ul>
            </div>
        </div>
      </div>
  </dialog>

  <div id="toast" class="toast" hidden>Copied!</div>

  <script>
    const API_BASE = "https://prompt-api.magistralofficialwork.workers.dev";

    // ------- State -------
    let allPrompts = [];
    let editingId = null;
    let viewing = null;
    let currentPage = 1;
    const PAGE_SIZE = 8;

    // ------- Elements -------
    const loader = document.getElementById('loader');
    const listEl = document.getElementById('promptList');
    const pagerEl = document.getElementById('pager');
    const searchBox = document.getElementById('searchBox');
    const categorySelect = document.getElementById('categorySelect');
    const subtypeSelect = document.getElementById('subtypeSelect');
    const sortSelect = document.getElementById('sortSelect');
    const modal = document.getElementById('promptModal');
    const form = document.getElementById('promptForm');
    const serviceInput = document.getElementById('serviceInput');
    const subtypeInput = document.getElementById('subtypeInput');
    const descInput = document.getElementById('descInput');
    const toolInput = document.getElementById('toolInput');
    const textInput = document.getElementById('textInput');
    const guidelinesInput = document.getElementById('guidelinesInput');
    const contribInput = document.getElementById('contribInput');
    const modalTitle = document.getElementById('modalTitle');
    const toast = document.getElementById('toast');
    const vModal = document.getElementById('viewModal');
    const vhCat = document.getElementById('vhCat');
    const vhSub = document.getElementById('vhSub');
    const vhTool = document.getElementById('vhTool');
    const vhDesc = document.getElementById('vhDesc');
    const vhGuidelines = document.getElementById('vhGuidelines');
    const guidelinesSection = document.getElementById('guidelinesSection');
    const vhText = document.getElementById('vhText');
    const detailContrib = document.getElementById('detailContrib').lastElementChild;
    const detailCreated = document.getElementById('detailCreated').lastElementChild;
    const detailEditor = document.getElementById('detailEditor');
    const detailEditorSpan = detailEditor.lastElementChild;
    const detailEdited = document.getElementById('detailEdited');
    const detailEditedSpan = detailEdited.lastElementChild;
    const detailCopied = document.getElementById('detailCopied').lastElementChild;
    const analyticsModal = document.getElementById('analyticsModal');

    // ------- Utils -------
    function showLoader() { loader.classList.add('show'); listEl.style.opacity = '0.4'; }
    function hideLoader() { loader.classList.remove('show'); listEl.style.opacity = '1'; }
    function showToast(msg) { toast.textContent = msg; toast.hidden = false; setTimeout(()=>toast.hidden=true, 1500); }
    function esc(s){ return (s ?? '').toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) }
    function parseDbTime(s){ if(!s) return null; const iso = s.includes('T') ? s : s.replace(' ','T') + 'Z'; return new Date(iso); }
    function fmtLocal(dt){ if(!dt) return ''; return new Intl.DateTimeFormat(undefined, { dateStyle: 'short', timeStyle: 'short' }).format(dt); }
    function asLinkIfURL(text){
      if(!text) return '';
      try { const u = new URL(text); return `<a href="${u.href}" target="_blank" rel="noopener noreferrer" class="tool">${esc(u.hostname)}</a>`; }
      catch { return `<span class="tool">${esc(text)}</span>`; }
    }
    function highlightSyntax(text) {
        return esc(text).replace(/\{([^}]+)\}/g, '<span class="placeholder">{$1}</span>');
    }
    function updateActiveFilters() {
        [categorySelect, subtypeSelect, sortSelect].forEach(sel => {
            if (sel.value && sel.selectedIndex > 0) {
                sel.classList.add('active-filter');
            } else {
                sel.classList.remove('active-filter');
            }
        });
    }

    function cardHTML(p){
      const created = fmtLocal(parseDbTime(p.created_at));
      const copies = (p.copied_count ?? 0);

      // NEW: HTML structure for card no longer includes an icon
      return `
        <article class="card" data-open="${p.id}" style="animation-delay: 0ms;">
          <div class="card-header">
            <span class="badge">${esc(p.service)}</span>
            ${p.subtype ? `<span class="chip">${esc(p.subtype)}</span>` : ''}
            <span class="card-copies">${copies} ${copies === 1 ? 'copy' : 'copies'}</span>
          </div>
          <div class="card-body">
            <p class="desc">${esc(p.description)}</p>
          </div>
          <div class="card-footer">
            <span>By ${esc(p.contributor)}</span>
            ${asLinkIfURL(p.ai_tool)}
          </div>
        </article>
      `;
    }
    
    function renderPager(totalPages){
      const btn = (label, page, disabled=false, active=false) =>
        `<button class="btn-page${active ? ' active':''}" ${disabled ? 'disabled':''} data-page="${page}">${label}</button>`;
      const gap = `<span class="gap">‚Ä¶</span>`;
      let html = '';
      if (totalPages <= 1) { pagerEl.innerHTML = ''; return; }
      html += btn('¬´', Math.max(1, currentPage - 1), currentPage === 1);
      const pages = [];
      const add = p => { if (p>=1 && p<=totalPages && !pages.includes(p)) pages.push(p); };
      add(1); add(totalPages);
      for (let p=currentPage-1; p<=currentPage+1; p++) add(p);
      pages.sort((a,b)=>a-b);
      pages.forEach((p,i)=>{
        if (i>0 && pages[i-1] !== p-1) html += gap;
        html += btn(p, p, false, p===currentPage);
      });
      html += btn('¬ª', Math.min(totalPages, currentPage + 1), currentPage === totalPages);
      pagerEl.innerHTML = html;
      pagerEl.querySelectorAll('[data-page]').forEach(b=>{
        b.onclick = () => { const go = Number(b.getAttribute('data-page')); if (go && go!==currentPage){ currentPage=go; render(); } };
      });
    }

    function getFilteredAndSortedData(){
      let data = [...allPrompts];
      const term = searchBox.value.trim().toLowerCase();
      if (term) data = data.filter(p => Object.values(p).some(val => String(val).toLowerCase().includes(term)));
      const cat = (categorySelect.value || '').toLowerCase();
      if (cat) data = data.filter(p => (p.service || '').toLowerCase() === cat);
      const sub = (subtypeSelect.value || '').toLowerCase();
      if (sub) data = data.filter(p => (p.subtype || '').toLowerCase() === sub);

      const sortMethod = sortSelect.value;
      if (sortMethod === 'oldest') {
        data.sort((a, b) => (parseDbTime(a.created_at) || 0) - (parseDbTime(b.created_at) || 0));
      } else if (sortMethod === 'copied') {
        data.sort((a, b) => (b.copied_count || 0) - (a.copied_count || 0));
      } else if (sortMethod === 'alphabetical') {
        data.sort((a, b) => (a.description || a.service).localeCompare(b.description || b.service));
      } else {
        data.sort((a, b) => (parseDbTime(b.created_at) || 0) - (parseDbTime(a.created_at) || 0));
      }
      return data;
    }

    function render(){
      listEl.classList.add('list-fade-out');
      
      setTimeout(() => {
        const data = getFilteredAndSortedData();
        updateActiveFilters();
        const totalPages = Math.max(1, Math.ceil(data.length / PAGE_SIZE));
        if (currentPage > totalPages) currentPage = totalPages;

        const start = (currentPage - 1) * PAGE_SIZE;
        const pageItems = data.slice(start, start + PAGE_SIZE);
        
        if(pageItems.length){
            listEl.innerHTML = pageItems.map(cardHTML).join('');
        } else {
            listEl.innerHTML = `
                <div class="muted">
                    <svg class="muted-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <h4>No Prompts Found</h4>
                    <p>Try adjusting your search or filters.</p>
                </div>`;
        }
        
        listEl.querySelectorAll('[data-open]').forEach(el => el.onclick = () => openView(Number(el.getAttribute('data-open'))));
        
        listEl.querySelectorAll('.card').forEach((card, index) => {
          card.style.animationDelay = `${index * 50}ms`;
        });
        
        renderPager(totalPages);
        listEl.classList.remove('list-fade-out');
      }, 150);
    }

    async function loadPrompts(){
      showLoader();
      try {
        const res = await fetch(`${API_BASE}/api/prompts`);
        if (!res.ok) throw new Error(`API responded with ${res.status}`);
        allPrompts = await res.json();
        render();
      } catch (err) {
        console.error("Failed to load prompts:", err);
        listEl.innerHTML = `<p class="muted">Error: Could not load prompts. Please refresh.</p>`;
        pagerEl.innerHTML = '';
      } finally {
        hideLoader();
      }
    }

    async function refreshTaxonomy(){
      showLoader();
      try {
        const res = await fetch(`${API_BASE}/api/prompts`);
        const all = await res.json();
        const cats = [...new Set(all.map(p => p.service).filter(Boolean))].sort();
        const currentCat = categorySelect.value;
        categorySelect.innerHTML = `<option value="">All categories</option>` + cats.map(c => `<option${(c === currentCat) ? ' selected' : ''} value="${esc(c)}">${esc(c)}</option>`).join('');
        const subs = all.filter(p => !currentCat || p.service === currentCat).map(p => p.subtype).filter(Boolean);
        const uniqueSubs = [...new Set(subs)].sort();
        const currentSub = subtypeSelect.value;
        subtypeSelect.innerHTML = `<option value="">All subtypes</option>` + uniqueSubs.map(s => `<option${(s === currentSub) ? ' selected' : ''} value="${esc(s)}">${esc(s)}</option>`).join('');
        subtypeSelect.disabled = uniqueSubs.length === 0;
      } catch (err) {
        console.error("Failed to refresh taxonomy:", err);
      } finally {
        hideLoader();
      }
    }

    function openView(id){
      const p = allPrompts.find(x => x.id === id);
      if(!p) return;
      viewing = p;
      vhCat.textContent = p.service || '';
      vhSub.textContent = p.subtype || '';
      vhSub.style.display = p.subtype ? 'inline-block' : 'none';
      vhTool.innerHTML = asLinkIfURL(p.ai_tool);
      vhDesc.textContent = p.description || '';
      if (p.usage_guidelines) {
        vhGuidelines.innerHTML = esc(p.usage_guidelines).replace(/\n/g, '<br>');
        guidelinesSection.style.display = 'block';
      } else {
        guidelinesSection.style.display = 'none';
      }
      vhText.innerHTML = highlightSyntax(p.prompt_text || '');
      detailContrib.textContent = p.contributor || '';
      detailCreated.textContent = fmtLocal(parseDbTime(p.created_at));
      detailCopied.textContent = `${p.copied_count || 0} times`;
      if (p.last_editor) {
        detailEditorSpan.textContent = p.last_editor;
        detailEditedSpan.textContent = fmtLocal(parseDbTime(p.last_edited_at));
        detailEditor.style.display = 'flex';
        detailEdited.style.display = 'flex';
      } else {
        detailEditor.style.display = 'none';
        detailEdited.style.display = 'none';
      }
      vModal.showModal();
    }

    function exportToCSV() {
      if (allPrompts.length === 0) { showToast('No prompts to export.'); return; }
      const headers = ['id','service','subtype','description','usage_guidelines','prompt_text','ai_tool','contributor','created_at','last_editor','last_edited_at','copied_count'];
      const csvRows = [headers.join(',')];
      for (const p of allPrompts) {
        const values = headers.map(h => `"${String(p[h] ?? '').replace(/"/g,'""')}"`);
        csvRows.push(values.join(','));
      }
      const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `prompt_hub_export_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
      URL.revokeObjectURL(link.href);
      showToast('Exported to CSV!');
    }

    function showAnalytics() {
      const topCopied = [...allPrompts]
        .sort((a,b)=>(b.copied_count||0)-(a.copied_count||0))
        .slice(0, 3);
      document.getElementById('topCopiedList').innerHTML =
        topCopied.length
          ? topCopied.map(p => `<li><span>${esc(p.description || p.service)}</span><span class="count">${p.copied_count || 0} copies</span></li>`).join('')
          : `<li>No copies yet.</li>`;
      const cold = allPrompts.filter(p => (p.copied_count || 0) === 0).slice(0, 10);
      document.getElementById('coldPromptsList').innerHTML =
        cold.length ? cold.map(p => `<li><span>${esc(p.description || p.service)}</span></li>`).join('') : `<li>All prompts have been used!</li>`;
      const categoryCounts = allPrompts.reduce((acc,p)=>{ acc[p.service]= (acc[p.service]||0)+1; return acc; },{});
      const sorted = Object.entries(categoryCounts).sort(([,a],[,b])=>b-a);
      document.getElementById('categoryCountList').innerHTML =
        sorted.map(([cat,count]) => `<li><span>${esc(cat)}</span><span class="count">${count} prompts</span></li>`).join('');
      analyticsModal.showModal();
    }

    // ------- Events -------
    document.getElementById('refreshBtn').onclick = async () => { await refreshTaxonomy(); await loadPrompts(); };
    document.getElementById('addBtn').onclick = () => {
      editingId = null; form.reset();
      modalTitle.textContent = 'Add Prompt';
      contribInput.value = 'Tanya';
      modal.showModal();
    };
    document.getElementById('exportBtn').onclick = exportToCSV;
    document.getElementById('analyticsBtn').onclick = showAnalytics;
    document.getElementById('vClose').onclick = () => { vModal.close(); viewing = null; };
    document.getElementById('analyticsClose').onclick = () => analyticsModal.close();
    document.getElementById('cancelForm').onclick = () => modal.close();
    searchBox.oninput = () => { currentPage = 1; render(); };
    categorySelect.onchange = async () => { currentPage = 1; await refreshTaxonomy(); render(); };
    subtypeSelect.onchange = () => { currentPage = 1; render(); };
    sortSelect.onchange = () => { currentPage = 1; render(); };

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = {
        service: serviceInput.value.trim(),
        subtype: subtypeInput.value.trim() || null,
        description: descInput.value.trim() || null,
        ai_tool: toolInput.value.trim() || null,
        prompt_text: textInput.value.trim(),
        usage_guidelines: guidelinesInput.value.trim() || null,
        contributor: contribInput.value.trim()
      };
      if (!payload.service || !payload.prompt_text || !payload.contributor) {
        alert('Category, Prompt text, and Contributor are required.');
        return;
      }
      const url = (editingId === null) ? `${API_BASE}/api/prompts` : `${API_BASE}/api/prompts/${editingId}`;
      const method = (editingId === null) ? 'POST' : 'PUT';
      const body = (editingId === null) ? payload : { ...payload, editor: payload.contributor || 'Editor' };
      await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      modal.close();
      editingId = null;
      await refreshTaxonomy();
      await loadPrompts();
      showToast('Saved');
    });

    document.getElementById('vCopy').onclick = async () => {
      if(!viewing) return;
      await navigator.clipboard.writeText(viewing.prompt_text || '');
      try { await fetch(`${API_BASE}/api/prompts/${viewing.id}/copied`, { method:'POST' }); } catch {}
      showToast('Copied!');
      const inList = allPrompts.find(p => p.id === viewing.id);
      if (inList) inList.copied_count = (inList.copied_count || 0) + 1;
      render();
    };

    document.getElementById('vEdit').onclick = () => {
      if(!viewing) return;
      editingId = viewing.id;
      serviceInput.value = viewing.service || '';
      subtypeInput.value = viewing.subtype || '';
      descInput.value = viewing.description || '';
      toolInput.value = viewing.ai_tool || '';
      textInput.value = viewing.prompt_text || '';
      guidelinesInput.value = viewing.usage_guidelines || '';
      contribInput.value = viewing.contributor || 'Tanya';
      modalTitle.textContent = 'Edit Prompt';
      vModal.close();
      modal.showModal();
    };

    document.getElementById('vDelete').onclick = async () => {
      if(!viewing) return;
      if (!confirm('Are you sure you want to delete this prompt?')) return;
      await fetch(`${API_BASE}/api/prompts/${viewing.id}`, { method:'DELETE' });
      vModal.close();
      viewing = null;
      await refreshTaxonomy();
      await loadPrompts();
      showToast('Deleted');
    };

    // Init
    (async () => {
      await refreshTaxonomy();
      await loadPrompts();
    })();
  </script>
</body>
</html>
